\documentclass{book}
\usepackage[utf8]{inputenc}
\usepackage{amsmath}
\usepackage{siunitx}
\usepackage{color}
\usepackage{amsfonts}

\usepackage{hyperref}

\usepackage{cleveref}
\crefformat{section}{\S#2#1#3} % see manual of cleveref, section 8.2.1
\crefformat{subsection}{\S#2#1#3}
\crefformat{subsubsection}{\S#2#1#3}


\usepackage{enumitem}

\newcommand{\pd}{\partial}

\title{Fully Self Consistent Simulations of the 1D Fuzzy Dark Matter and Particle System}
\author{Boris Zupancic}
\date{\today}

\begin{document}

\maketitle

\tableofcontents
%---------------------------------------------------------------------------------
% CHAPTER 1: THE SYSTEM

\chapter{The System}

The system is comprised of a Fuzzy Dark Matter (FDM) component, as well as a set of particles, both confined to a 1D box. The FDM and particles share the same gravitational potential, defined by their combined density $rho$ and Poisson's equation: 
\begin{equation*}
\nabla^2 \Phi = 4\pi G \rho    
\end{equation*}

The equations of motion (EOM) for FDM and the particles both rely on $\Phi$, but are different, as seen below. Our goal is to numerically integrate these equations of motion in a fully self-consistent manner.

\section{Fuzzy Dark Matter (FDM)}
The EOM for FDM in a periodic box is the Schrodinger-Poisson (SP) system :
\begin{equation}
    \begin{cases}
    i\hbar \frac{\pd \psi}{\pd t} = -\frac{\hbar^2}{2 m_\text{\tiny{FDM}}} \frac{\pd^2 \psi}{\pd x^2} + m_\text{\tiny{FDM}} \Phi \psi 
    \\
    \frac{\pd^2 \Phi}{\pd x^2} = 4\pi G \rho_\text{\tiny{FDM}}= 4\pi G m_\text{\tiny{FDM}} (|\psi|^2 - \langle |\psi|^2 \rangle)
    \end{cases}
    \label{SP}
\end{equation}
where $\hbar$ is the reduced Planck's constant, $m_{FDM}$ is the FDM-particle mass, $\Phi$ is the specific gravitational potential, and $\psi$ is a Schrodinger wave-function. The wave-function $\psi$ specifies the density:
$$\rho_\text{\tiny{FDM}} = m_\text{\tiny{FDM}}|\psi|^2$$
Thus $|\psi|^2$ is interpreted as a number density. Further notice that in Eq(\ref{SP}) the average number density is subtracted off in Poisson's equation. This is due to Gauss' Law requiring that the boundary conditions are null for a periodic box. 

To non-dimensionalize, we would like length, velocity, time and mass scales, $L_s, v_s,T_s,M_s$, such that
\begin{equation}
    \begin{cases}
    \Phi = v_s^2 \varphi\\
    \psi = L_s^{-3/2} \chi\\
    x = L_s z\\
    t = T_s \tau\\
    m_\text{\tiny{FDM}} = M_s \mu
    \end{cases}
    \label{Substitutions}
\end{equation}
To illustrate, let us fix length and velocity scales $L_s$ and $v_s$, respectively. For example, we may take:
$$L_s = \SI{1}{kpc} $$
$$v_s = \SI{100}{km.s^{-1}}$$
and then define a time scale 
$$T_s  = \frac{L_s}{v_s}$$
We may define a mass scale by first setting Newton's constant to unity $G = 1$, then:
$$[G] = M_s^{-1} L_s^3 T_s^{-2} \Rightarrow M_s \equiv \frac{L_s^3}{T_s^2} = v_s^2 L_s$$

We may further define a "fuzziness" parameter 
$$r \equiv \frac{\hbar}{2 m_\text{\tiny{FDM}} v_s L_s}$$
and finally substituting (\ref{Substitutions}) along with $r$ into Eq(\ref{SP}), our dimensionless SP system is:

\begin{equation}
    \begin{cases}
    i\frac{\pd \chi}{\pd \tau} = -r\frac{\pd^2 \chi}{\pd z^2} + \frac{1}{2r}\varphi\chi \\
    
    \frac{\pd^2 \varphi}{\pd z^2} = 4\pi\mu (\chi\chi^* - \langle\chi\chi^*\rangle)
    \end{cases}
    \label{SP-NonDim}
\end{equation}

\section{Particles}
In the particle scenario, the equation of motion is the familiar form of Newton's second law, where for a single particle with position $x$ and mass $m$ in a gravitational potential $U = m\Phi$:
$$\frac{d^2 x}{d t^2} = -\nabla\Phi = -\frac{\pd}{\pd x}\Phi(x,t)$$
Substituting the same dimensionless parameters (\ref{Substitutions}) as in the wave scenario:
$$\frac{d^2 z}{d\tau^2} = -\frac{\pd \varphi}{\pd z}$$

The gravitational potential is again given by Poisson's equation, and the particle density is 
\begin{equation}
\rho_\text{part} = n \cdot m_{\text{part}}
\label{Particle density}
\end{equation}

where $n$ is the volumetric/surface/linear number density and $m_{\text{part}}$ is the particle mass. We specify how to non-dimensionlize the particle density further down below in \cref{Poisson's Equation for Particles}, when we address the numerical schemes.
    
\section{Together}
Combining the above information, the dimensionless FDM + Particle system looks like:
\begin{equation}
    \begin{cases}
    i\frac{\pd \chi}{\pd \tau} = -r\frac{\pd^2 \chi}{\pd z^2} + \frac{1}{2r}\varphi\chi \\
    
    \frac{d^2 z}{d\tau^2} = -\frac{\pd \varphi}{\pd z}\\
    
    \frac{\pd^2 \varphi}{\pd z^2} = 4\pi \left[{\varrho} +\langle{\varrho}\rangle\right]
    \end{cases}
    \label{FULL-NonDim}
\end{equation}

where we take ${\varrho}$ as specifying the total density dimensionless density, given by the addition of FDM density and Particle density.
%------------------------------------------------------------------------------
% SECTION 2: NUMERICAL SCHEMES
\chapter{1D Numerical Schemes}

\section{Initial Setup}
The system is setup on a grid of $N$ linearly spaced points:
$$z = [z_0, z_1, z_2, ..., z_{N-1}]$$
(indexing starts with \texttt{i = 0} in Python3). These values will serve as edges for histogramming positions of particles, and positions at which the density, potential and acceleration fields are defined. The width of the bins is the constant
$$dz = z_{i+1} - z_i$$

The choice of $N$ will determine the accuracy of the FFT Poisson Solver described below; a higher value $N$ will both increase the accuracy, and increase the computational cost. 

In any given simulation, we further define the box width $L$, and apply the boundaries:
\begin{align}
    z_0 &= -L/2 \\ 
    z_{N-1} &= L/2
\end{align}

%\subsubsection{FDM}

%\subsubsection{Particles}

\subsection{Initial Conditions}
Our goal is to now setup an initial distribution of FDM and/or particles.

To create these initial conditions, a collection of particles is generated from a random gaussian distribution centered at 
$$z_\text{center} = \frac{z_0 -z_{N-1}}{2} $$
Each particle is given an initial velocity of zero: $v = 0$.

%\subsection{Calculating Physical Quantities}

\section{Calculating Density}
At any given time step of a simulation, it is necessary to calculate the acceleration field defined on the grid. To do this, density must be calculated first. It is straightforward to calculate the FDM density: $\varrho_\text{\tiny{FDM}} = m_\text{\tiny{FDM}}|\chi|^2$. Calculating particle density amounts to histogramming the positions of particles.

Following Equation (\ref{Particle density}), in our numerical scheme, the particle density in a given bin of length $d L_\text{box}$ will be:

\begin{equation}
\rho_k = \frac{N_k}{d L_\text{box}}\cdot \Sigma
\label{Numerical Particle Density}
\end{equation}
where $N_k$ is the number of particles counted in the $k^\text{th}$ bin, and $\Sigma$ is the mass per unit area defined for each particle. Note here that $\Sigma$ must have the specified dimensions in the 1D scenario, as each particle is really treated as an infinite 2D sheet perpendicular to our grid $z$. 

To retrieve a non-dimensional measure for density, we must consider again our scales. The values above may be written as:
\begin{equation*}
    \begin{cases}
    d L_\text{box} = L_s dz \\
    \Sigma = \frac{M}{L^2} \sigma
    \end{cases}
\end{equation*}
where $\sigma$ is a newly defined non-dimensional analogue for the mass (per unit area) of each particle. Substitution of these values into (\ref{Numerical Particle Density}) yields a newly defined (non-dim.) density:
$$\varrho_k \equiv \frac{L_s^3}{M_s} \rho_k = \frac{N_k}{dz}\sigma$$

\subsection{Poisson's Equation for Particles}\label{Poisson's Equation for Particles}
Now that we have covered how dimensionless particle density is calculated, we can non-dimensionalize the corresponding Poisson's Equation. In the dimensional case, Poisson's equation in a periodic box always looks like:
\begin{equation*}
    \nabla_x^2 \Phi = 4\pi G (\rho - \langle \rho \rangle) 
\end{equation*}

When we make the substitutions $\Phi = v_s^2 \varphi$ and $\rho_k = \frac{N_k}{dL_{box}}\cdot \Sigma$, we get (in our 1D case):
\begin{equation*}
    \frac{v_s^2}{L_s^2}\frac{\pd^2 \varphi}{\pd z^2} = 4\pi \frac{M_s}{L_s^3} \left( \frac{n_k}{\Delta z}\cdot \sigma - \left\langle \frac{n_k}{\Delta z}\cdot \sigma \right\rangle\right)
\end{equation*}
Which reduces to
\begin{equation}
    \frac{\pd^2 \varphi}{\pd z^2} = 4\pi \left( \frac{n_k}{\Delta z}\cdot \sigma - \left\langle \frac{n_k}{\Delta z}\cdot \sigma \right\rangle\right)
\end{equation}

\section{Calculating Potential}
The second main ingredient in evolving the system is knowing the gravitational potential $\Phi$, or in the dimensionless case, $\varphi$. We must solve for $\varphi$ from Poisson's Equation corresponding to FDM+Particles, seen in Eq(5), and we do so using a Fast-Fourier-Transform (FFT) method. The basic idea is that applying the Discrete-Discrete Fourier Transform (since we're in a periodic box with a discrete signal/sequence) on Poisson's equation yields:
\begin{equation*}
    \frac{\pd^2}{\pd z^2}\left(\sum_{n=0}^{N-1} \hat{\varphi}(k_n) e^{i k_n z}\right) = 4 \pi \left(\sum_{n=0}^{N-1} \hat{\varrho}(k_n) e^{i k_n z} - \langle\varrho\rangle\right)
\end{equation*}

where $k_n \equiv 2\pi n / L$, $L$ being the length of the box. Notice that $\langle\varrho\rangle = \hat{\varrho}(k_0)$, so that from the above equation we get:
\begin{equation*}
    \begin{cases}
    -k_n^2 \hat{\varphi}(k_n) = 4 \pi \hat{\varrho}(k_n) \text{, $\forall n \in \mathbb{N}$} \\
    0\cdot \hat{\varphi}(0) = 0
    \end{cases}
\end{equation*}
yielding Poisson's equation fully solvable on our 1D mesh by simply applying an FFT to the density and applying an IFFT to the Fourier Coefficients of the potential, defined by:
\begin{equation*}
    \begin{cases}
    \hat{\varphi}(k_n) = - \frac{4 \pi}{-k_n^2} \cdot \hat{\varrho}(k_n) \text{, $\forall n \in \mathbb{N}$} \\
    \hat{\varphi}(0) = 0
    \end{cases}
\end{equation*}

\section{Time Evolution}

The final ingredient in running a fully self-consistent simulation is evolving both the FDM and Particles with the same time-differencing scheme. We use a kick-drift-kick algorithm. Each step in the kick-drift-kick is performed at the same time for FDM and Particles (Kick FDM+Particles, then Drift FDM+Particles, etc.).


\subsection{FDM}
For the FDM, we employ a kick-drift-kick algorithm following \cite{Edwards_2018}, \cite{May&Springel_2021}, to solve Eq(\ref{SP-NonDim}):
\begin{align}
    \chi(\tau+\Delta \tau,z) & = \left[\mathcal{T} \circ e^{-i \int_\tau^{\tau+\Delta\tau} \left(-r \pd_z^2 + \frac{1}{2r}\varphi(\tau,z)\right) } \right]\cdot \chi(\tau,z) \\
    &  \approx  \left[ e^{-i\frac{\Delta\tau}{4r}\varphi(\tau+\Delta\tau,z)} \circ e^{ir\Delta\tau \pd_z^2}\circ e^{-i\frac{\Delta\tau}{4r}\varphi(\tau,z)} \right] \cdot \chi(\tau,z)\\
    & = \left[e^{-i\frac{\Delta\tau}{4r}\varphi(\tau+\Delta\tau,z)} \circ \text{FFT}^{-1}\circ e^{ir\Delta\tau k^2}\circ \text{FFT}\circ e^{-i\frac{\Delta\tau}{4r}\varphi(\tau,z)} \right] \cdot \chi(\tau,z)
\end{align}
The "kick-drift-kick" steps are identified as:
\begin{align*}
    & \text{KICK 1:}  \left[ e^{-i\frac{\Delta\tau}{4r}\varphi(\tau,z)}\right] \cdot \chi(\tau,z) \rightarrow \chi'(\tau,z) \\
    &\text{DRIFT:}  \left[\text{ FFT}^{-1}\circ e^{ir\Delta\tau k^2}\circ \text{FFT } \right] \chi'(\tau,z) \rightarrow \chi''(\tau,z) \\
    &\text{Update Potential} \\
    &\text{KICK 2:}  \left[e^{-i\frac{\Delta\tau}{4r}\varphi(\tau+\Delta\tau,z)} \right]\cdot \chi''(\tau,z) \rightarrow \chi(\tau+\Delta\tau,z)
\end{align*}

The "Update Potential" here (and below) means to recalculate the densities $\varrho_\text{\tiny{FDM}}$ and $\varrho_\text{part}$, and then solve Poisson's equation before continuing onto KICK 2.
\subsection{Particles} To evolve the particle system, we again employ a "kick-drift-kick" algorithm based off of that used for the FDM. We solve the particle EOM from Eqs(\ref{FULL-NonDim}), for an individual particle:
\begin{align*}
&\text{KICK 1: } v({\tau+\Delta\tau/2}) = v(\tau) + \frac{\Delta\tau}{2}a(\tau)\\
&\text{DRIFT: } z({\tau+\Delta\tau})+ \Delta\tau v({\tau+\Delta\tau/2})\\
&\text{Update Potential (to get $a({\tau+\Delta\tau/2}) = -\pd_z \varphi({\tau+\Delta\tau/2})$})\\
&\text{KICK 2: } v({\tau+\Delta\tau}) = v({\tau+\Delta\tau/2}) + \frac{\Delta\tau}{2}a({\tau+\Delta\tau/2})\\
\end{align*}

%-------------------------------------------------------------
% SECTION 3: SIMULATIONS
\chapter{Simulations}
So far, the numerical schemes outlined above have been coded in Python3, and a repo is available on GitHub \footnote{\hyperlink{https://github.com/BorisZupancic/FDM_n_Bodies}{BorisZupancic/FDM\_n\_Bodies} on GitHub.}.

In the program, the dimensional scales, as well as $G$,$\hbar$ and the total Mass $M$, are all set to unity,:
\begin{equation*}
    \begin{cases} L_s = 1\\ v_s = 1\\ \end{cases}\Rightarrow \begin{cases}T_s = 1\\ M_s = 1\end{cases} 
\end{equation*}
\begin{equation*}
    \begin{cases}
        G = 1\\
        \hbar = 1\\
        M = 1\\
    \end{cases}
\end{equation*}
    
Though not previously defined, the total mass of the FDM + Particle system is 
\begin{equation}
    M \equiv M_\text{\tiny{FDM}} + M_\text{part} \\
\end{equation}
where
\begin{align}
    M_\text{\tiny{FDM}} \equiv \int_{-L/2}^{L/2} \rho_\text{\tiny{FDM}} dz & &\text{and}& &
    M_\text{part} \equiv \int_{-L/2}^{L/2} \rho_\text{\tiny{part}} dz
\end{align}

We further define a new expression for the fuzziness parameter $r$ by rearranging:
\begin{equation}
    r \equiv \frac{\hbar}{2m_\text{\tiny{FDM}} v_s L_s} = \frac{1}{4\pi}\frac{h}{m_\text{\tiny{FDM}}\sigma_\text{\tiny{FDM}}} \frac{\sigma_\text{\tiny{FDM}}}{v_s}
\end{equation}

Simulations take in as input:
\begin{itemize}
    \item Box Length: L
    \item Percentage of total mass occupied by FDM.
    \item     
\end{itemize}
%-------------------------------------------------------------
% Section 4: ANALYSIS
\chapter{Analysis and Diagnostics}


%------------------------------------------
% APPENDIX
\appendix
\chapter{Spitzer Distribution}

\chapter{1D Virial Theorem}

\chapter{Kick-Drift-Kick is Symplectic}


%-----------------------------------------
% BIBLIOGRAPHY
\bibliographystyle{plain} % We choose the "plain" reference style
\bibliography{refs} % Entries are in the refs.bib file

\end{document}


